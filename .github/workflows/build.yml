name: Build SynK Binaries

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install Dependencies
        run: |
          pip install pyinstaller pillow requests
          
      - name: Build EXE (Directory Mode)
        run: |
          # --onedir creates a folder instead of a temp file (Fixes MEI Error)
          pyinstaller --noconsole --onedir --icon=app_icon.ico --name=SynK SynK.py
          
      - name: Prepare Release Zip
        shell: cmd
        run: |
          :: Move the build to a clean folder name
          move dist\SynK dist\SynK-Windows
          
          :: Copy Readme into the folder
          if exist README_Windows.txt copy README_Windows.txt dist\SynK-Windows\README.txt
          
          :: [CRITICAL FIX] Copy the Icon file so the Taskbar can find it
          if exist app_icon.ico copy app_icon.ico dist\SynK-Windows\app_icon.ico
          
          :: Zip the entire folder
          cd dist
          7z a ../SynK-Windows.zip SynK-Windows
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SynK-Windows
          path: SynK-Windows.zip

  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install Dependencies
        run: |
          pip install pyinstaller pillow requests
          
      - name: Build APP
        run: |
          pyinstaller --windowed --onefile --icon=app_icon.ico --name SynK SynK.py
          
      - name: Prepare Release Zip
        run: |
          mkdir release_dist
          cp -R dist/SynK.app release_dist/
          if [ -f README_Mac.txt ]; then cp README_Mac.txt release_dist/README.txt; fi
          cd release_dist
          zip -r ../SynK-MacOS.zip .
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SynK-MacOS
          path: SynK-MacOS.zip

  release:
    needs: [build-windows, build-mac]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            SynK-Windows/SynK-Windows.zip
            SynK-MacOS/SynK-MacOS.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}